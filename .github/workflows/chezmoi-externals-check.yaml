name: Validate chezmoi externals

on:
  push:
    paths:
      - "home/.chezmoiexternals/*.tmpl"
      - ".github/workflows/chezmoi-externals-check.yaml"
  pull_request:
    paths:
      - "home/.chezmoiexternals/*.tmpl"
      - ".github/workflows/chezmoi-externals-check.yaml"

jobs:
  externals-check:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm chezmoi git yq

      - name: Validate externals templates
        run: |
          set -euo pipefail
          failed=0

          for tmpl in home/.chezmoiexternals/*.tmpl; do
            echo "   ‚Ä¢ Validating $tmpl"

            # Render template
            if ! output=$(chezmoi execute-template < "$tmpl"); then
              echo "‚ùå Failed to render: $tmpl"
              failed=1
              continue
            fi

            # Optional: normalize quoted top-level keys for yq
            normalized_output=$(echo "$output" | sed 's/^"\(.*\)":/\1:/')

            # Check for URL presence
            if ! echo "$normalized_output" | grep -Eq 'url:[[:space:]]+\S+'; then
              echo "‚ùå Missing or empty url in: $tmpl"
              failed=1
              continue
            fi

            # Validate YAML syntax using yq v4
            if ! echo "$normalized_output" | yq eval -P - >/dev/null 2>&1; then
              echo "‚ùå Invalid YAML in: $tmpl"
              failed=1
              continue
            fi

            echo "‚úÖ OK: $tmpl"
          done

          if [ "$failed" -ne 0 ]; then
            echo "‚ùå Externals check failed"
            exit 1
          fi

          echo "üéâ All externals passed!"

#!/bin/bash

WALLPAPER_DIR="$HOME/.config/hypr/theme/walls"
CACHE_DIR="$HOME/.cache/wallpaper"
PERIOD=$(date +%p) # AM or PM
DATE=$(date +%F)
CACHE_FILE="$CACHE_DIR/wallpaper_${DATE}_${PERIOD}.txt"

mkdir -p "$CACHE_DIR"

for _ in {1..10}; do
  swww query &>/dev/null && break
  sleep 0.5
done

if ! swww query &>/dev/null; then
  notify-send "Wallpaper" "swww daemon is not running!" --urgency=critical
  exit 1
fi

CURRENT_DISPLAY=$(swww query | grep 'currently displaying:' | awk -F': ' '{print $2}')

# If showing color (fallback) and we have a cache, re-apply it
if [[ "$CURRENT_DISPLAY" == color:* && -f "$CACHE_FILE" ]]; then
  WALLPAPER=$(<"$CACHE_FILE")
  swww img "$WALLPAPER" \
    --transition-type fade \
    --transition-duration 2 \
    --transition-fps 60
  exit 0
fi

# Pick new wallpaper
SELECTED=$(fd . "$WALLPAPER_DIR" -t f | shuf -n 1)
if [[ -z "$SELECTED" ]]; then
  notify-send "Wallpaper" "No wallpapers found!" --urgency=critical
  exit 1
fi

rm -f "$CACHE_DIR"/wallpaper_*.txt

echo "$SELECTED" >"$CACHE_FILE"

swww img "$SELECTED" \
  --transition-type fade \
  --transition-duration 2 \
  --transition-fps 60

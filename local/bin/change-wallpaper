#!/bin/bash

WALLPAPER_DIR="$HOME/.config/hypr/theme/walls"
PERIOD=$(date +%p) # AM or PM
DATE=$(date +%F)
CACHE_FILE="$HOME/.cache/wallpaper_${DATE}_${PERIOD}.txt"

for _ in {1..10}; do
  swww query &>/dev/null && break
  sleep 0.5
done

if ! swww query &>/dev/null; then
  notify-send "Wallpaper" "swww daemon is not running!" --urgency=critical
  exit 1
fi

# Get current display type from swww
CURRENT_DISPLAY=$(swww query | grep 'currently displaying:' | awk -F': ' '{print $2}')

# If displaying a color or cache is missing, pick a new wallpaper
if [[ "$CURRENT_DISPLAY" == color:* || ! -f "$CACHE_FILE" ]]; then
  SELECTED=$(fd . "$WALLPAPER_DIR" -t f | shuf -n 1)
  if [[ -z "$SELECTED" ]]; then
    notify-send "Wallpaper" "No wallpapers found!" --urgency=critical
    exit 1
  fi
  echo "$SELECTED" >"$CACHE_FILE"
fi

# Use the cached wallpaper
WALLPAPER=$(<"$CACHE_FILE")

swww img "$WALLPAPER" \
  --transition-type fade \
  --transition-duration 2 \
  --transition-fps 60

# ðŸ§¹ Clean up old wallpaper cache files (>12h old)
find "$HOME/.cache" -name 'wallpaper_*.txt' -mmin +720 -delete

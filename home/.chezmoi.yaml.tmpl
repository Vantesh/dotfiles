{{- $skipPrompts := or (eq (env "NOCONFIRM") "1") (env "CI") (env "GITHUB_ACTIONS") (env "GITLAB_CI") (env "CODESPACES") -}}
{{- $personal := false -}}
{{- $defaultShell := "fish" -}}
{{- $compositor := "hyprland" -}}
{{- $setupSnapper := true -}}
{{- $setupHibernation := true -}}
{{- $installOptionalPackages := true -}}
{{- $installChaoticAUR := true -}}
{{- $installDrivers := true -}}

{{- $distroFamily := "" -}}
{{- if .chezmoi.osRelease -}}
  {{- $distroFamily = default .chezmoi.osRelease.id (index .chezmoi.osRelease "idLike") -}}
  {{- if not (or (contains $distroFamily "arch") (contains $distroFamily "fedora") (contains $distroFamily "rhel")) -}}
    {{- if lookPath "pacman" -}}
      {{- $distroFamily = "arch" -}}
    {{- else if lookPath "dnf" -}}
      {{- $distroFamily = "fedora" -}}
    {{- end -}}
  {{- end -}}
  {{- if contains $distroFamily "rhel" -}}
    {{- $distroFamily = "fedora" -}}
  {{- end -}}
{{- end -}}

{{- if not $skipPrompts -}}
  {{- writeToStdout "\n" -}}
  {{- warnf "\033[1;31mPlease do not select 'Y/y' or the setup will fail!\033[0m\n" -}}
  {{- $personal = promptBool "Is this a personal setup (y/N)" false -}}
  {{- $defaultShell = promptChoice "Preferred shell" (list "fish" "zsh") -}}
  {{- $compositor = promptChoice "Preferred compositor" (list "hyprland" "niri") -}}
  {{- $setupSnapper = promptBool "Setup Snapper snapshots (Y/n)" true -}}
  {{- $setupHibernation = promptBool "Setup hibernation (Y/n)" true -}}
  {{- $installOptionalPackages = promptBool "Install optional packages (Y/n)" true -}}
  {{- if contains $distroFamily "arch" -}}
    {{- $installChaoticAUR = promptBool "Install Chaotic AUR (Y/n)" true -}}
    {{- $installDrivers = promptBool "Install drivers (Y/n)" true -}}
  {{- end -}}
{{- end -}}

data:
  defaultShell: {{ $defaultShell | quote }}
  compositor: {{ $compositor | quote }}
  personal: {{ $personal }}
  distroFamily: {{ $distroFamily | lower | quote }}
  setupSnapper: {{ $setupSnapper }}
  setupHibernation: {{ $setupHibernation }}
  installOptionalPackages: {{ $installOptionalPackages }}
  installChaoticAUR: {{ $installChaoticAUR }}
  installDrivers: {{ $installDrivers }}

scriptEnv:
  PERSONAL: {{ ternary "1" "0" $personal | quote }}
  DISTRO_FAMILY: {{ $distroFamily | lower | quote }}
  DISTRO: {{ .chezmoi.osRelease.id | quote }}
  DEFAULT_SHELL: {{ $defaultShell | quote }}
  COMPOSITOR: {{ $compositor | quote }}
  SETUP_SNAPPER: {{ ternary "1" "0" $setupSnapper | quote }}
  SETUP_HIBERNATION: {{ ternary "1" "0" $setupHibernation | quote }}
  INSTALL_OPTIONAL_PACKAGES: {{ ternary "1" "0" $installOptionalPackages | quote }}
  INSTALL_CHAOTIC_AUR: {{ ternary "1" "0" $installChaoticAUR | quote }}
  INSTALL_DRIVERS: {{ ternary "1" "0" $installDrivers | quote }}

edit:
  command: code
  args: [--wait]

merge:
  command: bash
  args: [-c, "cp {{ "{{" }} .Target {{ "}}" }} {{ "{{" }} .Target {{ "}}" }}.base && code --new-window --wait --merge {{ "{{" }} .Destination {{ "}}" }} {{ "{{" }} .Target {{ "}}" }} {{ "{{" }} .Target {{ "}}" }}.base {{ "{{" }} .Source {{ "}}" }}"]

diff:
  command: delta
  args: [--paging=never, "{{ "{{ .Destination }}" }}", "{{ "{{ .Target }}" }}"]
  pager: delta
  exclude: [scripts]

github:
  refreshPeriod: 24h

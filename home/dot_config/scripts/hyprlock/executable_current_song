#!/bin/bash

get_current_song() {
  SPOTIFY_ICON="<span color='#A6E3A1'>󰓇 </span>"
  FIREFOX_ICON="<span color='#F38BA8'> </span>"
  VLC_ICON="<span color='#FFDB3C'>󰕼 </span>"
  YOUTUBE_ICON="<span color='#FF0033'>  </span>"

  command -v playerctl &>/dev/null || exit 1

  current_player=$(playerctl -a metadata -f '{{playerName}} {{status}}' 2>/dev/null | awk '$2 == "Playing" {print $1; exit}')
  [ -z "$current_player" ] && exit 0

  title=$(playerctl -p "$current_player" metadata title 2>/dev/null)
  artist=$(playerctl -p "$current_player" metadata artist 2>/dev/null)

  # Clean unwanted tags from title
  cleaned_title=$(echo "$title" | sed -E \
    -e 's/\s*[-|–]*\s*\(?official music video\)?//I' \
    -e 's/\s*[-|–]*\s*\(?official video\)?//I' \
    -e 's/\s*[-|–]*\s*\(?lyrics\)?//I' \
    -e 's/\s*[-|–]*\s*\(?HD\)?//I' \
    -e 's/\s*\[[^]]*\]//g' \
    -e 's/\s*\([^)]*\)//g' \
    -e 's/\s{2,}/ /g' \
    -e 's/^\s+|\s+$//g')

  escape_pango() {
    echo "$1" | sed \
      -e 's/&/\&amp;/g' \
      -e 's/</\&lt;/g' \
      -e 's/>/\&gt;/g' \
      -e 's/"/\&quot;/g' \
      -e "s/'/\&apos;/g"
  }

  escape_artist=$(escape_pango "$artist")
  escape_title=$(escape_pango "$cleaned_title")

  case "$current_player" in
  *YoutubeMusic*) icon="$YOUTUBE_ICON" ;;
  *spotify*) icon="$SPOTIFY_ICON" ;;
  *mpv*) icon="" ;;
  *vlc*) icon="$VLC_ICON" ;;
  *firefox*) icon="$FIREFOX_ICON" ;;
  *brave*) icon="" ;;
  *chromium* | *chrome*) icon="" ;;
  *) icon="" ;;
  esac

  if [ -n "$escape_title" ]; then
    if [[ -n "$escape_artist" && "$escaped_title" != *"$escape_artist"* ]]; then
      echo "$icon $escape_artist - $escape_title"
    else
      echo "$icon $escape_title"
    fi
  fi
}

get_current_song

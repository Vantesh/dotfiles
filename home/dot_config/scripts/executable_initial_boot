#!/usr/bin/env bash

# First-boot setup: set a random wallpaper and reload Hyprland once.
# Sentinel file follows XDG Base Directory spec and lives in XDG_STATE_HOME

# Determine sentinel location
STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/${XDG_CURRENT_DESKTOP:-unknown}"
SENTINEL_NEW="$STATE_DIR/first_setup_done"

# Run only if the sentinel is missing (i.e., first setup not yet done)
if [[ ! -f "$SENTINEL_NEW" ]]; then
    sleep 1
    if command -v qs >/dev/null 2>&1; then
        WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
        PROFILE_IMAGE="$HOME/.cache/wal/icon.png"
        OLD_PROFILE_IMAGE="$HOME/.cache/hyprlock/profile.png"
        # Migrate old profile image if it exists and new one does not
        if [[ -f "$OLD_PROFILE_IMAGE" && ! -f "$PROFILE_IMAGE" ]]; then
            mv "$OLD_PROFILE_IMAGE" "$PROFILE_IMAGE"
        fi

        if [[ ! -d "$WALLPAPER_DIR" ]] || ! find "$WALLPAPER_DIR" -type f -print -quit | grep -q .; then
            if command -v notify-send >/dev/null 2>&1; then
                notify-send --icon=dialog-error "Wallpaper" "Missing or empty: $WALLPAPER_DIR"
                notify-send --icon=dialog-error "Wallpaper" "Add a wallpaper and restart Hyprland"
            fi
            exit 1
        fi

        RANDOM_WALLPAPER=$(find "$WALLPAPER_DIR" -type f | shuf -n 1)
        qs -c dms ipc call wallpaper set "$RANDOM_WALLPAPER" >/dev/null 2>&1 &
        qs -c dms ipc call profile setImage "$PROFILE_IMAGE" >/dev/null 2>&1 &
        wait
    fi

    # Create the new sentinel to mark first-setup completion
    [[ ! -d "$STATE_DIR" ]] && mkdir -p "$STATE_DIR"
    printf "# DO NOT DELETE THIS FILE\n# This file indicates the first setup has been completed.\n" >"$SENTINEL_NEW"
    notify-send --icon=nwg-look "Welcome" "First setup completed successfully! Enjoy your Hyprland experience."
fi

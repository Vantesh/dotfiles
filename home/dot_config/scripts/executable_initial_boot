#!/usr/bin/env bash
# initial_boot - First-boot setup: set random wallpaper and reload Hyprland
# Exit codes: 0 (success), 1 (failure)

set -euo pipefail

readonly STATE_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/${XDG_CURRENT_DESKTOP:-unknown}"
readonly SENTINEL_NEW="$STATE_DIR/first_setup_done"
readonly WALLPAPER_DIR="$HOME/Pictures/Wallpapers"
readonly PROFILE_IMAGE="$HOME/.cache/wal/icon.png"

main() {
    if [[ -f "$SENTINEL_NEW" ]]; then
        return 0
    fi

    sleep 1

    if ! command -v qs >/dev/null 2>&1; then
        return 0
    fi

    if [[ ! -d "$WALLPAPER_DIR" ]] || ! find "$WALLPAPER_DIR" -type f -print -quit | grep -q .; then
        if command -v notify-send >/dev/null 2>&1; then
            notify-send --icon=dialog-error "Wallpaper" "Missing or empty: $WALLPAPER_DIR"
            notify-send --icon=dialog-error "Wallpaper" "Add a wallpaper and restart Hyprland"
        fi
        return 1
    fi

    local random_wallpaper
    random_wallpaper="$(find "$WALLPAPER_DIR" -type f | shuf -n 1)"

    qs -c dms ipc call wallpaper set "$random_wallpaper" >/dev/null 2>&1 &
    qs -c dms ipc call profile setImage "$PROFILE_IMAGE" >/dev/null 2>&1 &
    wait

    if [[ ! -d "$STATE_DIR" ]]; then
        mkdir -p "$STATE_DIR"
    fi

    printf "# DO NOT DELETE THIS FILE\n# This file indicates the first setup has been completed.\n" >"$SENTINEL_NEW"

    if command -v notify-send >/dev/null 2>&1; then
        notify-send --icon=nwg-look "Welcome" "First setup completed successfully! Enjoy your Hyprland experience."
    fi

    return 0
}

main "$@"

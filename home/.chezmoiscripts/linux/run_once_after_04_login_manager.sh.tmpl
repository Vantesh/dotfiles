#!/usr/bin/env bash
# 04_login_manager.sh - Configure Ly display manager
# Exit codes: 0 (success), 1 (failure)

set -euo pipefail

shopt -s nullglob globstar

readonly LIB_DIR="${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/.chezmoiscripts/linux/lib"

# shellcheck source=/dev/null
source "$LIB_DIR/.lib-common.sh"

readonly LY_CONFIG_FILE="/etc/ly/config.ini"
readonly LY_SAVE_FILE="/etc/ly/save.ini"

disable_conflicting_dms() {
  local skip_service="${1:-}"

  local other_dm_services=(
    gdm.service gdm3.service sddm.service lightdm.service lxdm.service
    greetd.service emptty.service
  )

  local disabled_any=false
  local svc

  for svc in "${other_dm_services[@]}"; do
    if [[ "$skip_service" != "" ]] && [[ "$svc" == "$skip_service" ]]; then
      continue
    fi

    if systemctl list-unit-files --type=service 2>/dev/null | grep -q "^${svc}"; then
      if sudo systemctl is-enabled --quiet "$svc" 2>/dev/null; then
        if sudo systemctl disable "$svc" >/dev/null 2>&1; then
          log INFO "Disabled $svc"
          disabled_any=true
        else
          log WARN "Failed to disable $svc"
        fi
      fi
    fi
  done

  # Force systemd to reload after disabling services
  if [[ "$disabled_any" = true ]]; then
    reload_systemd_daemon
    log INFO "Conflicting display managers disabled"
  else
    log SKIP "No conflicting display managers found"
  fi
}

configure_ly() {
  declare -A ly_config=(
    ["allow_empty_password"]="false"
    ["clear_password"]="true"
    ["bg"]="0"
    ["fg"]="8"
    ["bigclock"]="en"
    ["hide_key_hints"]="true"
    ["border_fg"]="8"
    ["path"]="null"
    ["sleep_cmd"]="systemctl suspend"
    ["session_log"]="/tmp/ly-session.log"
  )

  local key
  for key in "${!ly_config[@]}"; do
    if ! update_config "$LY_CONFIG_FILE" "$key" "${ly_config[$key]}"; then
      die "Failed to update ly config: $LAST_ERROR"
    fi
  done

  if ! write_system_config "$LY_SAVE_FILE" <<EOF; then
user=${USER}
session_index=2
EOF
    die "Failed to write ly save file: $LAST_ERROR"
  fi

  log INFO "Configured ly display manager"
}

disable_getty_tty2() {
  if sudo systemctl disable getty@tty2.service >/dev/null 2>&1; then
    log INFO "Disabled getty@tty2.service"
  else
    log WARN "Failed to disable getty@tty2.service"
  fi
}

{{- if eq .compositor "niri" }}
setup_niri_session() {
  local session_file="/usr/share/wayland-sessions/niri-uwsm.desktop"

  if [[ -f "$session_file" ]]; then
    log SKIP "niri-uwsm session already configured"
    return 0
  fi

  if ! write_system_config "$session_file" <<'EOF'; then
[Desktop Entry]
Name=Niri (uwsm-managed)
Comment=A scrollable-tiling Wayland compositor
Exec=uwsm start -- niri.desktop
TryExec=uwsm
Type=Application
DesktopNames=niri
EOF
    die "Failed to create niri session file: $LAST_ERROR"
  fi

  log INFO "Created niri-uwsm session file"
}
{{- end }}

main() {
  local is_fedora="false"
  if command_exists dnf; then
    is_fedora="true"
  fi

  if [[ "$is_fedora" == "true" ]]; then
    print_box "Display Manager"
    log STEP "Display Manager Configuration"

    log SKIP "Fedora distro detected, skipping Ly configuration"

{{- if eq .compositor "niri" }}
    setup_niri_session
{{- end }}
    return 0
  fi

  print_box "LY"
  log STEP "Ly Configuration"

  disable_conflicting_dms
  configure_ly

  if ! enable_service "ly.service" "system"; then
    die "Failed to enable ly.service: $LAST_ERROR"
  fi
  log INFO "Enabled ly.service"

  disable_getty_tty2

{{- if eq .compositor "niri" }}
  setup_niri_session
{{- end }}

  log INFO "Ly display manager configuration complete"
}

main "$@"

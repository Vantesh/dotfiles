#!/usr/bin/env bash
# 02_packages.sh - Install fedora packages
# Exit codes: 0 (success), 1 (failure)

set -euo pipefail

shopt -s nullglob globstar

readonly LIB_DIR="${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/.chezmoiscripts/linux/lib"

# shellcheck source=/dev/null
source "$LIB_DIR/.lib-common.sh"
# shellcheck source=/dev/null
source "$LIB_DIR/.lib-package_manager.sh"
# shellcheck source=/dev/null
source "$LIB_DIR/.lib-fedora_repos.sh"
# shellcheck source=/dev/null
source "$LIB_DIR/.lib-xdg_setup.sh"

if [[ "$(id -u)" -eq 0 ]]; then
  die "Do not run this script as root."
fi

if ! keep_sudo_alive; then
  die "Failed to keep sudo alive"
fi

if [[ "${SKIP_PACKAGES:-0}" == "1" ]]; then
  log INFO "Skipping package installation"
  exit 0
fi

if ! setup_xdg; then
  die "XDG setup failed: $LAST_ERROR"
fi

log INFO "Configured XDG directories"

print_box "Packages"

# ============================================================================
# COPR Repositories
# ============================================================================
log STEP "COPR Repositories"

copr_repos=(
{{- range .fedora.copr_repos }}
  "{{ . }}"
{{- end }}
)

for repo in "${copr_repos[@]}"; do
  if ! sudo dnf copr list --enabled 2>/dev/null | grep -q "^copr:copr.fedorainfracloud.org:$repo"; then
    log INFO "Enabling COPR repo: $repo"
    if ! sudo dnf copr enable -y "$repo" >/dev/null 2>&1; then
      log WARN "Failed to enable COPR repo: $repo"
    fi
  else
    log SKIP "COPR repo already enabled: $repo"
  fi
done

# ============================================================================
# Core Packages
# ============================================================================
core_pkgs=(
{{- range .fedora.core }}
  "{{ . }}"
{{- end }}
  "{{ .defaultShell }}"
)

{{- if eq .compositor "hyprland" }}
core_pkgs+=(
{{- range .fedora.compositor.hyprland }}
  "{{ . }}"
{{- end }}
)
{{- else if eq .compositor "niri" }}
core_pkgs+=(
{{- range .fedora.compositor.niri }}
  "{{ . }}"
{{- end }}
)
{{- end }}

install_group "Core" "${core_pkgs[@]}"

# ============================================================================
# CLI Tools
# ============================================================================
cli_pkgs=(
{{- range .fedora.cli }}
  "{{ . }}"
{{- end }}
)
install_group "CLI Tools" "${cli_pkgs[@]}"

# ============================================================================
# Theming
# ============================================================================
theme_pkgs=(
{{- range .fedora.theming }}
  "{{ . }}"
{{- end }}
)
install_group "Theming" "${theme_pkgs[@]}"

# ============================================================================
# Fonts
# ============================================================================
font_pkgs=(
{{- range .fedora.fonts }}
  "{{ . }}"
{{- end }}
)
install_group "Fonts" "${font_pkgs[@]}"

# ============================================================================
# Optional Packages
# ============================================================================
if [[ "${INSTALL_OPTIONAL_PACKAGES:-1}" == "1" ]]; then
  opt_pkgs=(
{{- range .fedora.optional }}
    "{{ . }}"
{{- end }}
  )

  if [[ ${#opt_pkgs[@]} -gt 0 ]]; then
    needs_vscode_repo=0

    for package in "${opt_pkgs[@]}"; do
      if [[ "$package" = "code" ]]; then
        needs_vscode_repo=1
        break
      fi
    done

    if [[ $needs_vscode_repo -eq 1 ]]; then
      if ! setup_vscode_repo; then
        die "Visual Studio Code repo setup failed: $LAST_ERROR"
      fi
      log INFO "Visual Studio Code repo configured"
    fi

    install_group "Optional" "${opt_pkgs[@]}"
  fi
else
  log INFO "Skipping optional packages"
fi

# ============================================================================
# Laptop Packages
# ============================================================================
if is_laptop; then
  laptop_pkgs=(
{{- range .fedora.laptop }}
    "{{ . }}"
{{- end }}
  )
  install_group "Laptop" "${laptop_pkgs[@]}"
fi

# ============================================================================
# Snapper Packages
# ============================================================================
if [[ "${SETUP_SNAPPER:-1}" == "1" ]]; then
  snapper_pkgs=(
{{- range .fedora.snapper }}
    "{{ . }}"
{{- end }}
  )
  install_group "Snapper" "${snapper_pkgs[@]}"
else
  log INFO "Skipping Snapper installation"
fi

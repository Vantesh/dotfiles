#!/usr/bin/env bash

# shellcheck disable=SC1091
source "${CHEZMOI_SOURCE_DIR:?env variable missing. Please only run this script via chezmoi}/.chezmoiscripts/linux/helpers/.00_helpers"
source "${CHEZMOI_SOURCE_DIR:?env variable missing. Please only run this script via chezmoi}/.chezmoiscripts/linux/helpers/.01_chaotic_aur"
source "${CHEZMOI_SOURCE_DIR:?env variable missing. Please only run this script via chezmoi}/.chezmoiscripts/linux/helpers/.02_XDG"

common_init
print_box "smslant" "Packages"

install_group() {
  local label="$1"
  shift

  [[ $# -eq 0 ]] && return

  print_step "Installing ${label} packages"
  install_package "$@"
}

if ! has_chaotic_repo; then
  if confirm "Chaotic AUR repo is not installed. Do you want to install it?"; then
    install_chaotic_repo
  else
    print_info "Skipping Chaotic AUR"
  fi
fi

print_step "Updating system"
sudo pacman -Syu --noconfirm

core_pkgs=({{- range .Arch.core }} "{{ . }}"{{- end }} "{{ .default_shell }}")

{{- if eq .compositor "hyprland" }}
core_pkgs+=({{- range .Arch.compositor.hyprland }} "{{ . }}"{{- end }})
{{- else if eq .compositor "niri" }}
core_pkgs+=({{- range .Arch.compositor.niri }} "{{ . }}"{{- end }})
{{- end }}

install_group "Core packages" "${core_pkgs[@]}"

cli_pkgs=({{- range .Arch.cli }} "{{ . }}"{{- end }})
install_group "CLI Tools" "${cli_pkgs[@]}"

theme_pkgs=({{- range .Arch.theming }} "{{ . }}"{{- end }})
install_group "Theming" "${theme_pkgs[@]}"

font_pkgs=({{- range .Arch.fonts }} "{{ . }}"{{- end }})
install_group "Fonts" "${font_pkgs[@]}"

aur_pkgs=({{- range .Arch.aur }} "{{ . }}"{{- end }})
install_group "AUR" "${aur_pkgs[@]}"

if confirm "Do you want to install drivers?"; then
  drivers=({{- range .Arch.drivers.base }} "{{ . }}"{{- end }})

  kernel_version=$(uname -r)
  case "$kernel_version" in
    *-zen*)     drivers+=("{{ .Arch.drivers.kernelHeaders.zen }}") ;;
    *-lts*)     drivers+=("{{ .Arch.drivers.kernelHeaders.lts }}") ;;
    *-cachyos*) drivers+=("{{ .Arch.drivers.kernelHeaders.cachyos }}") ;;
    *)          drivers+=("{{ .Arch.drivers.kernelHeaders.default }}") ;;
  esac

  gpu_info=$(lspci -nn | grep -Ei "VGA|3D|Display")

  if [[ $gpu_info == *"NVIDIA"* ]]; then
    drivers+=({{- range .Arch.drivers.nvidia }} "{{ . }}"{{- end }})
    nvidia_variant=""
    if echo "$gpu_info" | grep -q -E "RTX [2-9][0-9]|GTX 16"; then
      nvidia_variant="nvidia-open-dkms"
    else
      nvidia_variant="nvidia-dkms"
    fi

    if [[ "{{ .distro }}" == "cachyos" ]]; then
      print_warning "Detected CachyOS : skipping ${nvidia_variant}."
    else
      drivers+=("$nvidia_variant")
    fi
  fi

  [[ $gpu_info == *"AMD/ATI"* ]] && drivers+=({{- range .Arch.drivers.amd }} "{{ . }}"{{- end }})
  [[ $gpu_info == *"Intel"* ]] && drivers+=({{- range .Arch.drivers.intel }} "{{ . }}"{{- end }})

  install_group "Drivers" "${drivers[@]}"
fi

if hostnamectl chassis | grep -qi "laptop\|notebook"; then
  laptop_pkgs=({{- range .Arch.laptop }} "{{ . }}"{{- end }})
  install_group "Laptop" "${laptop_pkgs[@]}"
fi

if confirm "Install optional packages?"; then
  opt_pkgs=({{- range .Arch.optional }} "{{ . }}"{{- end }})
  install_group "Optional" "${opt_pkgs[@]}"
fi

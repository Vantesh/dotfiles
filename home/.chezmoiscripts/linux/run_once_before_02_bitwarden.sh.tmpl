#!/usr/bin/env bash
{{- if .personal }}
# shellcheck disable=SC1091
source "${CHEZMOI_SOURCE_DIR:?env variable missing. Please only run this script via chezmoi}/.chezmoiscripts/linux/helpers/.00_helpers"

# =============================================================================
# Install Bitwarden
# =============================================================================
print_box "smslant" "Bitwarden"
print_step "Setting up Bitwarden"

packages=(
  "bitwarden-bin"
  "rbw"
)

install_package "${packages[@]}"

# ==========================================================================
# LOGIN
# ==========================================================================

validate_email() {
  local email="$1"
  [[ "$email" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]
}

get_bitwarden_email() {
  local email
  while true; do
    read -r -p "Enter your Bitwarden email: " email
    if validate_email "$email"; then
      echo "$email"
      return 0
    else
      print_warning "Invalid email format. Please try again."
    fi
  done
}

# ==========================================================================
# FIX FOR BRAVE & CHROMIUM-BASED BROWSERS
# ==========================================================================
create_bitwarden_manifest() {
  local target_dir="$1"
  local manifest="$target_dir/com.8bit.bitwarden.json"

  # Skip if manifest already exists
  if [[ -f "$manifest" ]]; then
    return 0
  fi

  mkdir -p "$target_dir"

  cat >"$manifest" <<'EOF'
{
  "name": "com.8bit.bitwarden",
  "description": "Bitwarden desktop <-> browser bridge",
  "path": "/usr/lib/bitwarden/desktop_proxy",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://nngceckbapebfimnlniiiahkandclblb/",
    "chrome-extension://hccnnhgbibccigepcmlgppchkpfdophk/",
    "chrome-extension://jbkfoedolllekgbhcbcoahefnbanhhlh/",
    "chrome-extension://ccnckbpmaceehanjmeomladnmlffdjgn/"
  ]
}
EOF
  print_info "Created Bitwarden manifest: $manifest"
}

# Brave
create_bitwarden_manifest "$HOME/.config/BraveSoftware/Brave-Browser/NativeMessagingHosts"

# Google Chrome
create_bitwarden_manifest "$HOME/.config/google-chrome/NativeMessagingHosts"


if ! rbw login >/dev/null 2>&1; then
  print_step "Logging in to Bitwarden"
  email=$(get_bitwarden_email)
  rbw config set email "$email"
  rbw login
else
  print_info "Bitwarden is already logged in. Skipping login step."
fi

{{- end }}

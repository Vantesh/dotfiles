#!/usr/bin/env bash
# shellcheck disable=SC1091
source "${CHEZMOI_SOURCE_DIR:?env variable missing. Please only run this script via chezmoi}/.chezmoiscripts/linux/helpers/.00_helpers"

# =============================================================================
# Initialize Environment
# =============================================================================
common_init

#===================================================================================
# Ly
#===================================================================================

print_step "Setting up Ly display manager"
# -----------------------------------------------------------------------------
# Disable any other active display/login managers before enabling ly
# -----------------------------------------------------------------------------
print_info "Checking for other display managers to disable"

other_dm_services=(
  gdm.service gdm3.service sddm.service lightdm.service lxdm.service
  greetd.service emptty.service
)

disabled_any=false
for svc in "${other_dm_services[@]}"; do
  if systemctl list-unit-files --type=service | grep -q "^${svc}"; then
    if systemctl is-enabled --quiet "$svc" 2>/dev/null; then
      if [[ "$svc" != "ly.service" ]]; then
        if sudo systemctl disable "$svc" >/dev/null 2>&1; then
          print_info "Disabled conflicting display manager: $svc"
          disabled_any=true
        else
          print_warning "Failed to disable $svc"
        fi
      fi
    fi
  fi
done

if [[ "$disabled_any" == true ]]; then
  print_info "Conflicting display managers disabled"
else
  print_info "No conflicting enabled display managers found"
fi

readonly LY_CONFIG_FILE="/etc/ly/config.ini"
readonly LY_SAVE_FILE="/etc/ly/save.ini"

declare -A ly_config=(
  ["allow_empty_password"]="false"
  ["clear_password"]="true"
  ["bg"]="0"
  ["fg"]="8"
  ["bigclock"]="en"
  # ["hide_version_string"]="true" # expected in ly v1.1.3
  ["hide_key_hints"]="true"
  ["border_fg"]="8"
  ["path"]="null"
  ["sleep_cmd"]="systemctl suspend"
  ["session_log"]="/tmp/ly-session.log"
)

for key in "${!ly_config[@]}"; do
  update_config "$LY_CONFIG_FILE" "$key" "${ly_config[$key]}"
done

write_system_config "$LY_SAVE_FILE" "Ly session save file" <<EOF
user=${USER}
session_index=2
EOF

enable_service "ly.service" "system"

if sudo systemctl disable getty@tty2.service >/dev/null 2>&1; then
  print_info "TTY2 service disabled successfully"
else
  print_warning "Failed to disable TTY2 service"
fi

{{- if eq .compositor "niri" }}
if ! grep -q "niri-uwsm.desktop" /usr/share/wayland-sessions/*; then
  print_info "Adding niri (uwsm managed) to list of available sessions"
  write_system_config "/usr/share/wayland-sessions/niri-uwsm.desktop" "niri (uwsm managed) session file" <<EOF
[Desktop Entry]
Name=Niri (uwsm-managed)
Comment=A scrollable-tiling Wayland compositor
Exec=uwsm start -- niri.desktop
TryExec=uwsm
Type=Application
DesktopNames=niri
EOF
else
  print_info "niri (uwsm managed) already in list of available sessions"
fi
{{- end }}

#!/usr/bin/env bash

# shellcheck disable=SC1091
source "${CHEZMOI_SOURCE_DIR:?env variable missing. Please only run this script via chezmoi}/.chezmoiscripts/linux/helpers/.00_helpers"

# =============================================================================
# Install Bitwarden
# =============================================================================
{{- if eq .chezmoi.username "vantesh" }}
print_box "smslant" "Bitwarden"

install_package "bitwarden"
install_package "bitwarden-cli"

# ==========================================================================
# LOGIN
# ==========================================================================

validate_email() {
  local email="$1"
  [[ "$email" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$ ]]
}

get_bitwarden_email() {
  local email
  while true; do
    read -r -p "Enter your Bitwarden email: " email
    if validate_email "$email"; then
      echo "$email"
      return 0
    else
      print_warning "Invalid email format. Please try again."
    fi
  done
}

bw_login() {
  if bw login --check &>/dev/null && bw unlock --check &>/dev/null; then
    print_info "Bitwarden is already logged in and unlocked."
    return 0
  fi

  if ! bw login --check &>/dev/null; then
    print_info "Bitwarden CLI is not logged in. Please log in."

    local email session_token
    email=$(get_bitwarden_email)

    if ! session_token=$(bw login "$email" --raw ); then
      print_error "Bitwarden login failed. Please check your credentials."
      return 1
    fi

    export BW_SESSION="$session_token"
    bw sync
    print_info "Successfully logged in and synced."
    return 0
  fi

  if ! bw unlock --check &>/dev/null; then
    print_info "Bitwarden is locked. Please provide your master password to unlock."

    local session_token attempts=0
    local -r max_attempts=3

    while (( attempts < max_attempts )); do
      if session_token=$(bw unlock --raw); then
        export BW_SESSION="$session_token"
        print_info "Bitwarden unlocked successfully."
        return 0
      fi

      (( ++attempts ))
      if (( attempts < max_attempts )); then
        print_warning "Invalid master password. Attempt $attempts of $max_attempts. Please try again."
      else
        print_error "Failed to unlock Bitwarden vault after $max_attempts attempts."
        return 1
      fi
    done
  fi
}

bw_login

# =============================================================================
# SSH Setup
# =============================================================================

setup_ssh() {
  local -r ssh_dir="$HOME/.ssh"
  local -r known_hosts="$ssh_dir/known_hosts"

  if [[ ! -d "$ssh_dir" ]]; then
    print_info "Creating SSH directory..."
    mkdir -p "$ssh_dir"
    chmod 700 "$ssh_dir"
  fi

  local -a hosts=("github.com" "gitlab.com")

  for host in "${hosts[@]}"; do
    if [[ ! -f "$known_hosts" ]] || ! grep -q "^$host " "$known_hosts" 2>/dev/null; then
      print_info "Adding $host to known_hosts..."
      ssh-keyscan "$host" >> "$known_hosts" 2>/dev/null || {
        print_warning "Failed to add $host to known_hosts"
      }
    else
      print_info "$host already in known_hosts"
    fi
  done

  [[ -f "$known_hosts" ]] && chmod 644 "$known_hosts"
}

setup_ssh

{{- end }}

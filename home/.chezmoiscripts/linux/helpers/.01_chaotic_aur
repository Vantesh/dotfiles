#!/usr/bin/env bash

# --- Chaotic AUR configuration ---
CHAOTIC_KEY="3056513887B78AEB"
CHAOTIC_KEYSERVER="keyserver.ubuntu.com"
CHAOTIC_CDN="https://cdn-mirror.chaotic.cx/chaotic-aur"
CHAOTIC_KEYRING_URL="$CHAOTIC_CDN/chaotic-keyring.pkg.tar.zst"
CHAOTIC_MIRRORLIST_URL="$CHAOTIC_CDN/chaotic-mirrorlist.pkg.tar.zst"

has_chaotic_repo() {
  grep -q "chaotic-aur" /etc/pacman.conf
}

install_chaotic_aur() {
  # --- Import GPG key ---
  print_info "Checking Chaotic AUR GPG key..."
  if ! sudo pacman-key --list-keys "$CHAOTIC_KEY" &>/dev/null; then
    print_info "Importing GPG key..."
    if sudo pacman-key --recv-key "$CHAOTIC_KEY" --keyserver "$CHAOTIC_KEYSERVER" &>/dev/null &&
      sudo pacman-key --lsign-key "$CHAOTIC_KEY" &>/dev/null; then
      print_info "GPG key installed successfully"
    else
      print_error "Failed to install the GPG key"
    fi
  else
    print_info "GPG key already present"
  fi

  # --- Install keyring ---
  print_info "Checking Chaotic keyring..."
  if ! pacman -Qi chaotic-keyring &>/dev/null; then
    if sudo pacman -U --noconfirm "$CHAOTIC_KEYRING_URL" &>/dev/null; then
      print_info "Chaotic keyring installed successfully"
    else
      print_error "Failed to install the Chaotic keyring"
    fi
  else
    print_info "Chaotic keyring already installed"
  fi

  # --- Install mirrorlist ---
  print_info "Checking Chaotic mirrorlist..."
  if ! pacman -Qi chaotic-mirrorlist &>/dev/null; then
    if sudo pacman -U --noconfirm "$CHAOTIC_MIRRORLIST_URL" &>/dev/null; then
      print_info "Chaotic mirrorlist installed successfully"
    else
      print_error "Failed to install the Chaotic mirrorlist"
    fi
  else
    print_info "Chaotic mirrorlist already installed"
  fi

  # --- Add repo to pacman.conf ---
  if ! has_chaotic_repo; then
    print_info "Adding Chaotic AUR repo to pacman.conf..."
    if echo -e "\n[chaotic-aur]\nInclude = /etc/pacman.d/chaotic-mirrorlist" |
      sudo tee -a /etc/pacman.conf &>/dev/null; then
      print_info "Chaotic AUR repo added successfully"
    else
      print_error "Failed to add Chaotic AUR repo"
    fi
  else
    print_info "Chaotic AUR repo already present in pacman.conf"
  fi

  # --- Sync repos ---
  print_info "Updating package databases..."
  if sudo pacman -Sy &>/dev/null; then
    print_info "Package databases updated successfully"
  else
    print_error "Failed to update package databases"
  fi
}

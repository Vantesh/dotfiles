#!/bin/bash

# =============================================================================
# CONFIGURATION ARRAYS
# =============================================================================

readonly USER_SERVICES=(
  hyprpolkitagent.service
  gnome-keyring-daemon.service
  hypridle.service
  hyprpaper.service
)

readonly SYSTEM_SERVICES=(
  bluetooth.service
  paccache.timer
  sddm.service
  ufw.service
)

readonly DNSCRYPT_CONFIG_FILE="/etc/dnscrypt-proxy/dnscrypt-proxy.toml"
readonly NETWORKMANAGER_CONF="/etc/NetworkManager/conf.d/no-systemd-resolved.conf"

# =============================================================================
# SERVICE MANAGEMENT FUNCTIONS
# =============================================================================

enable_user_services() {
  printc cyan "Enabling user services..."
  for service in "${USER_SERVICES[@]}"; do
    enable_service "$service" "user"
  done
}

enable_system_services() {
  printc cyan "Enabling system services..."
  for service in "${SYSTEM_SERVICES[@]}"; do
    enable_service "$service" "system"
  done
}

enable_ufw_firewall() {
  printc cyan "Enabling UFW firewall..."
  sudo ufw enable || fail "Failed to enable UFW firewall."
  printc green "UFW firewall enabled successfully."
}

# =============================================================================
# DNS CONFIGURATION FUNCTIONS
# =============================================================================

install_dnscrypt_proxy() {
  if ! has_cmd dnscrypt-proxy; then
    printc cyan "Installing dnscrypt-proxy..."
    install_package "dnscrypt-proxy" || fail "Failed to install dnscrypt-proxy."
  else
    printc yellow "dnscrypt-proxy is already installed."
  fi
}

configure_resolv_conf() {
  printc cyan "Configuring /etc/resolv.conf..."
  sudo rm -f /etc/resolv.conf || fail "Failed to remove existing resolv.conf."
  sudo tee /etc/resolv.conf >/dev/null <<EOF
#Generated by dnscrypt-proxy
nameserver ::1
nameserver 127.0.0.1
options edns0
EOF
  printc cyan "Making /etc/resolv.conf immutable..."
  sudo chattr +i /etc/resolv.conf || fail "Failed to make resolv.conf immutable."
  printc green "resolv.conf configured and made immutable."
}

configure_dnscrypt_proxy() {
  printc cyan "Configuring dnscrypt-proxy..."
  declare -A config_values=(
    ["server_names"]="['cloudflare', 'cloudflare-ipv6']"
  )

  printc cyan "Updating $DNSCRYPT_CONFIG_FILE with DNS settings..."
  for key in "${!config_values[@]}"; do
    update_config "$DNSCRYPT_CONFIG_FILE" "$key" "${config_values[$key]}"
  done

  enable_service "dnscrypt-proxy.service" "system"
  printc green "dnscrypt-proxy configured successfully."
}

disable_systemd_resolved() {
  printc cyan "Disabling systemd-resolved..."

  # Create NetworkManager configuration to disable systemd-resolved
  if [[ ! -f "$NETWORKMANAGER_CONF" ]]; then
    sudo tee "$NETWORKMANAGER_CONF" >/dev/null <<EOF
[main]
systemd-resolved=false
EOF
    printc green "Created $NETWORKMANAGER_CONF to disable systemd-resolved."
  else
    printc yellow "$NETWORKMANAGER_CONF already exists, skipping creation."
  fi

  # Stop and disable systemd-resolved service
  if sudo systemctl is-active --quiet systemd-resolved; then
    sudo systemctl stop systemd-resolved || fail "Failed to stop systemd-resolved."
    sudo systemctl disable systemd-resolved || fail "Failed to disable systemd-resolved."
    printc green "systemd-resolved service stopped and disabled."

    # Restart NetworkManager to apply changes
    sudo systemctl restart NetworkManager || fail "Failed to restart NetworkManager."
    printc green "NetworkManager restarted to apply changes."
  else
    printc yellow "systemd-resolved service is not active, skipping stop/disable."
  fi
}

setup_dns_over_https() {
  printc cyan "Setting up DNS over HTTPS..."

  install_dnscrypt_proxy
  configure_resolv_conf
  configure_dnscrypt_proxy
  disable_systemd_resolved

  printc green "DNS over HTTPS setup completed successfully."
}

# =============================================================================
# MAIN EXECUTION FUNCTIONS
# =============================================================================

main() {
  enable_user_services
  enable_system_services
  enable_ufw_firewall

  if confirm "Setup DNS over HTTPS using dnscrypt-proxy?"; then
    setup_dns_over_https
  else
    printc yellow "Skipping DNS over HTTPS setup."
  fi
}

main
